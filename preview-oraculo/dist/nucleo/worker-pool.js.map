{"version":3,"file":"worker-pool.js","sourceRoot":"","sources":["../../src/nucleo/worker-pool.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\r\n/**\r\n * Sistema de Pool de Workers para Processamento Paralelo de Arquivos\r\n *\r\n * Permite processar múltiplos arquivos em paralelo usando Worker Threads,\r\n * melhorando a performance em projetos grandes com muitos arquivos.\r\n */\r\n\r\nimport { Worker } from 'node:worker_threads';\r\nimport * as path from 'node:path';\r\nimport * as os from 'node:os';\r\nimport type {\r\n  FileEntryWithAst,\r\n  Tecnica,\r\n  Ocorrencia,\r\n  ContextoExecucao,\r\n  MetricaAnalista,\r\n} from '@tipos/tipos.js';\r\nimport { ocorrenciaErroAnalista } from '@tipos/tipos.js';\r\nimport { config } from '@nucleo/constelacao/cosmos.js';\r\nimport { log } from '@nucleo/constelacao/log.js';\r\n\r\nexport interface WorkerPoolOptions {\r\n  /** Número máximo de workers simultâneos (padrão: número de CPUs) */\r\n  maxWorkers?: number;\r\n  /** Tamanho do lote de arquivos por worker (padrão: 10) */\r\n  batchSize?: number;\r\n  /** Timeout por analista em ms (padrão: valor do config) */\r\n  timeoutMs?: number;\r\n  /** Se deve usar workers (padrão: true se disponível) */\r\n  enabled?: boolean;\r\n}\r\n\r\nexport interface WorkerTask {\r\n  files: FileEntryWithAst[];\r\n  techniques: Tecnica[];\r\n  context: ContextoExecucao;\r\n  workerId: number;\r\n}\r\n\r\nexport interface WorkerResult {\r\n  workerId: number;\r\n  occurrences: Ocorrencia[];\r\n  metrics: MetricaAnalista[];\r\n  processedFiles: number;\r\n  errors: string[];\r\n  duration: number;\r\n}\r\n\r\n/**\r\n * Pool de workers para processamento paralelo de arquivos\r\n */\r\nexport class WorkerPool {\r\n  private maxWorkers: number;\r\n  private batchSize: number;\r\n  private timeoutMs: number;\r\n  private enabled: boolean;\r\n  private activeWorkers = 0;\r\n  private results: WorkerResult[] = [];\r\n  private errors: string[] = [];\r\n\r\n  constructor(options: WorkerPoolOptions = {}) {\r\n    // Se o valor foi passado via options usa ele; se config define 0 usamos nº de CPUs\r\n    const configuredMax = options.maxWorkers ?? config.WORKER_POOL_MAX_WORKERS ?? 0;\r\n    this.maxWorkers = configuredMax > 0 ? configuredMax : Math.max(1, os.cpus().length);\r\n    this.batchSize = options.batchSize ?? 10;\r\n    // Timeout base vindo de opções/config\r\n    let baseTimeout = options.timeoutMs ?? config.ANALISE_TIMEOUT_POR_ANALISTA_MS;\r\n    // Permite sobrescrever com variável de ambiente para ambientes de produção\r\n    const envCap = Number(process.env.ORACULO_MAX_ANALYST_TIMEOUT_MS) || 0;\r\n    if (envCap > 0) {\r\n      baseTimeout = Math.min(baseTimeout, envCap);\r\n    } else if (process.env.NODE_ENV === 'production') {\r\n      // Em produção, por padrão, limitamos para não exceder 10s salvo override explícito\r\n      baseTimeout = Math.min(baseTimeout, 10000);\r\n    }\r\n    this.timeoutMs = baseTimeout;\r\n    this.enabled = options.enabled ?? config.WORKER_POOL_ENABLED !== false;\r\n\r\n    // Verifica se Worker Threads estão disponíveis\r\n    if (!this.enabled || !Worker) {\r\n      this.enabled = false;\r\n      log.info('Pool de workers desabilitado (Worker Threads não disponível)');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Processa arquivos usando pool de workers\r\n   */\r\n  async processFiles(\r\n    files: FileEntryWithAst[],\r\n    techniques: Tecnica[],\r\n    context: ContextoExecucao,\r\n  ): Promise<{\r\n    occurrences: Ocorrencia[];\r\n    metrics: MetricaAnalista[];\r\n    totalProcessed: number;\r\n    duration: number;\r\n  }> {\r\n    if (!this.enabled || files.length < this.batchSize) {\r\n      // Fallback para processamento sequencial\r\n      return this.processSequentially(files, techniques, context);\r\n    }\r\n\r\n    const startTime = performance.now();\r\n    const batches = this.createBatches(files);\r\n    const nonGlobalTechniques = techniques.filter((t) => !t.global);\r\n\r\n    log.info(`🚀 Iniciando processamento paralelo com ${this.maxWorkers} workers`);\r\n    log.info(`📦 ${batches.length} lotes de até ${this.batchSize} arquivos cada`);\r\n\r\n    // Processa lotes globais primeiro\r\n    const globalTechniques = techniques.filter((t) => t.global);\r\n    if (globalTechniques.length > 0) {\r\n      await this.processGlobalTechniques(globalTechniques, context);\r\n    }\r\n\r\n    // Processa lotes de arquivos em paralelo\r\n    await this.processBatches(batches, nonGlobalTechniques, context);\r\n\r\n    const duration = performance.now() - startTime;\r\n    const totalOccurrences = this.results.reduce((sum, r) => sum + r.occurrences.length, 0);\r\n    const totalMetrics = this.results.flatMap((r) => r.metrics);\r\n\r\n    log.info(`✅ Processamento paralelo concluído em ${Math.round(duration)}ms`);\r\n    log.info(\r\n      `📊 ${this.results.length} workers, ${files.length} arquivos, ${totalOccurrences} ocorrências`,\r\n    );\r\n\r\n    return {\r\n      occurrences: this.results.flatMap((r) => r.occurrences),\r\n      metrics: totalMetrics,\r\n      totalProcessed: files.length,\r\n      duration,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Cria lotes de arquivos para processamento paralelo\r\n   */\r\n  private createBatches(files: FileEntryWithAst[]): FileEntryWithAst[][] {\r\n    const batches: FileEntryWithAst[][] = [];\r\n    for (let i = 0; i < files.length; i += this.batchSize) {\r\n      batches.push(files.slice(i, i + this.batchSize));\r\n    }\r\n    return batches;\r\n  }\r\n\r\n  /**\r\n   * Processa técnicas globais (não paralelizáveis)\r\n   */\r\n  private async processGlobalTechniques(\r\n    techniques: Tecnica[],\r\n    context: ContextoExecucao,\r\n  ): Promise<void> {\r\n    for (const technique of techniques) {\r\n      try {\r\n        const startTime = performance.now();\r\n        const result = await this.executeTechniqueWithTimeout(\r\n          technique,\r\n          '', // conteúdo vazio para técnicas globais\r\n          '[global]',\r\n          null, // sem AST\r\n          undefined, // sem fullPath\r\n          context,\r\n        );\r\n\r\n        if (result) {\r\n          const occurrences = Array.isArray(result) ? result : [result];\r\n          this.results.push({\r\n            workerId: -1, // ID especial para global\r\n            occurrences,\r\n            metrics: [\r\n              {\r\n                nome: technique.nome || 'global',\r\n                duracaoMs: performance.now() - startTime,\r\n                ocorrencias: occurrences.length,\r\n                global: true,\r\n              },\r\n            ],\r\n            processedFiles: 0,\r\n            errors: [],\r\n            duration: performance.now() - startTime,\r\n          });\r\n        }\r\n      } catch (error) {\r\n        const err = error as Error;\r\n        this.errors.push(`Erro em técnica global '${technique.nome}': ${err.message}`);\r\n        this.results.push({\r\n          workerId: -1,\r\n          occurrences: [\r\n            ocorrenciaErroAnalista({\r\n              mensagem: `Falha na técnica global '${technique.nome}': ${err.message}`,\r\n              relPath: '[execução global]',\r\n              origem: technique.nome,\r\n            }),\r\n          ],\r\n          metrics: [],\r\n          processedFiles: 0,\r\n          errors: [err.message],\r\n          duration: 0,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Processa lotes de arquivos em paralelo\r\n   */\r\n  private async processBatches(\r\n    batches: FileEntryWithAst[][],\r\n    techniques: Tecnica[],\r\n    context: ContextoExecucao,\r\n  ): Promise<void> {\r\n    // Conjunto de promises ativas para controle fino (removemos quando conclu\u0000eddas)\r\n    const activePromises = new Set<Promise<void>>();\r\n\r\n    for (let i = 0; i < batches.length; i++) {\r\n      // Espera até ter vaga para novo worker\r\n      while (this.activeWorkers >= this.maxWorkers) {\r\n        // Aguarda a primeira promise ativa resolver (libera capacidade)\r\n        if (activePromises.size === 0) break;\r\n        await Promise.race(Array.from(activePromises));\r\n      }\r\n\r\n      const p = this.processBatch(batches[i], techniques, context, i);\r\n      activePromises.add(p);\r\n\r\n      // Quando a promise terminar, remove do conjunto\r\n      p.then(() => activePromises.delete(p)).catch(() => activePromises.delete(p));\r\n    }\r\n\r\n    // Aguarda todas as promises ativas terminarem\r\n    await Promise.all(Array.from(activePromises));\r\n  }\r\n\r\n  /**\r\n   * Processa um lote de arquivos em um worker\r\n   */\r\n  private async processBatch(\r\n    files: FileEntryWithAst[],\r\n    techniques: Tecnica[],\r\n    context: ContextoExecucao,\r\n    batchId: number,\r\n  ): Promise<void> {\r\n    this.activeWorkers++;\r\n\r\n    try {\r\n      const workerPath = path.join(__dirname, 'worker-executor.js');\r\n\r\n      // Calcula timeout adaptativo por lote baseado no tamanho médio dos arquivos\r\n      const avgSize =\r\n        files.reduce((s, f) => s + (f.content ? f.content.length : 0), 0) /\r\n        Math.max(1, files.length);\r\n      const sizeMultiplier = 1 + Math.min(4, avgSize / 50000);\r\n      const batchTimeoutMs = Math.max(\r\n        1000,\r\n        Math.min(this.timeoutMs, Math.floor(this.timeoutMs * sizeMultiplier)),\r\n      );\r\n\r\n      const worker = new Worker(workerPath, {\r\n        workerData: {\r\n          files,\r\n          techniques,\r\n          context,\r\n          workerId: batchId,\r\n          timeoutMs: batchTimeoutMs,\r\n        } as WorkerTask,\r\n      });\r\n\r\n      const workerKillMs = Math.max(30000, this.timeoutMs * 2 || 30000);\r\n      const adjustedKillMs = Math.max(1000, Math.min(workerKillMs, batchTimeoutMs + 1000));\r\n\r\n      const result = await new Promise<WorkerResult>((resolve, reject) => {\r\n        let settled = false;\r\n        // Timer para forçar término caso worker trave por muito tempo\r\n        let killTimer: NodeJS.Timeout | null = setTimeout(() => {\r\n          if (settled) return;\r\n          settled = true;\r\n          try {\r\n            worker.terminate();\r\n          } catch {\r\n            /* ignore */\r\n          }\r\n          // Log estruturado para kills (ajuda em observabilidade em produção)\r\n          try {\r\n            log.infoSemSanitizar(\r\n              JSON.stringify({\r\n                event: 'worker_killed',\r\n                batchId,\r\n                adjustedKillMs,\r\n                reason: 'timeout',\r\n              }),\r\n            );\r\n          } catch {}\r\n          reject(new Error(`Worker ${batchId} killed after ${adjustedKillMs}ms`));\r\n        }, adjustedKillMs);\r\n\r\n        worker.on('message', (msg: unknown) => {\r\n          const m = msg as Record<string, unknown>;\r\n          // Heartbeat: rearmar o kill timer\r\n          if (m && m['type'] === 'heartbeat') {\r\n            try {\r\n              if (killTimer) clearTimeout(killTimer);\r\n            } catch {}\r\n            killTimer = setTimeout(() => {\r\n              if (settled) return;\r\n              settled = true;\r\n              try {\r\n                worker.terminate();\r\n              } catch {}\r\n              try {\r\n                log.infoSemSanitizar(\r\n                  JSON.stringify({\r\n                    event: 'worker_killed',\r\n                    batchId,\r\n                    adjustedKillMs,\r\n                    reason: 'heartbeat_timeout',\r\n                  }),\r\n                );\r\n              } catch {}\r\n              reject(\r\n                new Error(`Worker ${batchId} killed after ${adjustedKillMs}ms (heartbeat timeout)`),\r\n              );\r\n            }, adjustedKillMs);\r\n            return;\r\n          }\r\n\r\n          if (settled) return;\r\n          settled = true;\r\n          try {\r\n            if (killTimer) clearTimeout(killTimer);\r\n          } catch {}\r\n          // Normaliza a mensagem retornada pelo worker para o formato WorkerResult esperado\r\n          try {\r\n            const workerId =\r\n              typeof m['workerId'] === 'number' ? (m['workerId'] as number) : batchId;\r\n            const occurrences = Array.isArray(m['occurrences'])\r\n              ? (m['occurrences'] as Ocorrencia[])\r\n              : Array.isArray(m['resultados'])\r\n                ? (m['resultados'] as Ocorrencia[])\r\n                : [];\r\n            const metrics = Array.isArray(m['metrics']) ? (m['metrics'] as MetricaAnalista[]) : [];\r\n            const processedFiles =\r\n              typeof m['processedFiles'] === 'number'\r\n                ? (m['processedFiles'] as number)\r\n                : files.length || 0;\r\n            const errors = Array.isArray(m['errors'])\r\n              ? (m['errors'] as string[]).map(String)\r\n              : m['erro']\r\n                ? [String(m['erro'])]\r\n                : [];\r\n            const duration = typeof m['duration'] === 'number' ? (m['duration'] as number) : 0;\r\n\r\n            const workerResult: WorkerResult = {\r\n              workerId,\r\n              occurrences,\r\n              metrics,\r\n              processedFiles,\r\n              errors: errors as string[],\r\n              duration,\r\n            };\r\n            resolve(workerResult);\r\n          } catch (e) {\r\n            reject(e);\r\n          }\r\n        });\r\n\r\n        worker.on('error', (err) => {\r\n          if (settled) return;\r\n          settled = true;\r\n          try {\r\n            if (killTimer) clearTimeout(killTimer);\r\n          } catch {}\r\n          reject(err);\r\n        });\r\n\r\n        worker.on('exit', (code) => {\r\n          if (settled) return;\r\n          settled = true;\r\n          try {\r\n            if (killTimer) clearTimeout(killTimer);\r\n          } catch {}\r\n          if (code !== 0) {\r\n            try {\r\n              log.infoSemSanitizar(JSON.stringify({ event: 'worker_exit_nonzero', batchId, code }));\r\n            } catch {}\r\n            reject(new Error(`Worker ${batchId} exited with code ${code}`));\r\n          } else {\r\n            resolve({\r\n              workerId: batchId,\r\n              occurrences: [],\r\n              metrics: [],\r\n              processedFiles: files.length,\r\n              errors: [],\r\n              duration: 0,\r\n            });\r\n          }\r\n        });\r\n      });\r\n\r\n      this.results.push(result);\r\n    } catch (error) {\r\n      const err = error as Error;\r\n      this.errors.push(`Erro no worker ${batchId}: ${err.message}`);\r\n\r\n      // Adiciona resultado de erro\r\n      this.results.push({\r\n        workerId: batchId,\r\n        occurrences: [\r\n          ocorrenciaErroAnalista({\r\n            mensagem: `Falha no worker ${batchId}: ${err.message}`,\r\n            relPath: `[worker-${batchId}]`,\r\n            origem: 'worker-pool',\r\n          }),\r\n        ],\r\n        metrics: [],\r\n        processedFiles: 0,\r\n        errors: [err.message],\r\n        duration: 0,\r\n      });\r\n    } finally {\r\n      this.activeWorkers--;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Processamento sequencial como fallback\r\n   */\r\n  private async processSequentially(\r\n    files: FileEntryWithAst[],\r\n    techniques: Tecnica[],\r\n    context: ContextoExecucao,\r\n  ): Promise<{\r\n    occurrences: Ocorrencia[];\r\n    metrics: MetricaAnalista[];\r\n    totalProcessed: number;\r\n    duration: number;\r\n  }> {\r\n    const startTime = performance.now();\r\n    const occurrences: Ocorrencia[] = [];\r\n    const metrics: MetricaAnalista[] = [];\r\n\r\n    log.info('🔄 Usando processamento sequencial (workers desabilitados)');\r\n\r\n    // Processa técnicas globais\r\n    const globalTechniques = techniques.filter((t) => t.global);\r\n    for (const technique of globalTechniques) {\r\n      try {\r\n        const result = await this.executeTechniqueWithTimeout(\r\n          technique,\r\n          '',\r\n          '[global]',\r\n          null,\r\n          undefined,\r\n          context,\r\n        );\r\n\r\n        if (result) {\r\n          const occs = Array.isArray(result) ? result : [result];\r\n          occurrences.push(...occs);\r\n        }\r\n      } catch (error) {\r\n        const err = error as Error;\r\n        occurrences.push(\r\n          ocorrenciaErroAnalista({\r\n            mensagem: `Falha na técnica global '${technique.nome}': ${err.message}`,\r\n            relPath: '[execução global]',\r\n            origem: technique.nome,\r\n          }),\r\n        );\r\n      }\r\n    }\r\n\r\n    // Processa arquivos sequencialmente\r\n    const nonGlobalTechniques = techniques.filter((t) => !t.global);\r\n    for (const file of files) {\r\n      for (const technique of nonGlobalTechniques) {\r\n        if (technique.test && !technique.test(file.relPath)) continue;\r\n\r\n        try {\r\n          const startTime = performance.now();\r\n          const result = await this.executeTechniqueWithTimeout(\r\n            technique,\r\n            file.content ?? '',\r\n            file.relPath,\r\n            file.ast ?? null,\r\n            file.fullPath,\r\n            context,\r\n          );\r\n\r\n          if (result) {\r\n            const occs = Array.isArray(result) ? result : [result];\r\n            occurrences.push(...occs);\r\n          }\r\n\r\n          const duration = performance.now() - startTime;\r\n          metrics.push({\r\n            nome: technique.nome || 'desconhecido',\r\n            duracaoMs: duration,\r\n            ocorrencias: Array.isArray(result) ? result.length : result ? 1 : 0,\r\n            global: false,\r\n          });\r\n        } catch (error) {\r\n          const err = error as Error;\r\n          occurrences.push(\r\n            ocorrenciaErroAnalista({\r\n              mensagem: `Falha na técnica '${technique.nome}' para ${file.relPath}: ${err.message}`,\r\n              relPath: file.relPath,\r\n              origem: technique.nome,\r\n            }),\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      occurrences,\r\n      metrics,\r\n      totalProcessed: files.length,\r\n      duration: performance.now() - startTime,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Executa uma técnica com timeout\r\n   */\r\n  private async executeTechniqueWithTimeout(\r\n    technique: Tecnica,\r\n    content: string,\r\n    relPath: string,\r\n    ast: import('@babel/traverse').NodePath<import('@babel/types').Node> | null,\r\n    fullPath: string | undefined,\r\n    context: ContextoExecucao,\r\n  ): Promise<ReturnType<Tecnica['aplicar']>> {\r\n    if (this.timeoutMs > 0) {\r\n      let timer: NodeJS.Timeout | null = null;\r\n      const timeoutPromise = new Promise<never>((_, reject) => {\r\n        timer = setTimeout(() => {\r\n          reject(new Error(`Timeout: analista '${technique.nome}' excedeu ${this.timeoutMs}ms`));\r\n        }, this.timeoutMs);\r\n      });\r\n\r\n      const execPromise = technique.aplicar(content, relPath, ast, fullPath, context);\r\n      try {\r\n        return await Promise.race([execPromise, timeoutPromise]);\r\n      } finally {\r\n        if (timer) clearTimeout(timer);\r\n      }\r\n    } else {\r\n      return await technique.aplicar(content, relPath, ast, fullPath, context);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retorna estatísticas do pool\r\n   */\r\n  getStats() {\r\n    return {\r\n      maxWorkers: this.maxWorkers,\r\n      batchSize: this.batchSize,\r\n      enabled: this.enabled,\r\n      activeWorkers: this.activeWorkers,\r\n      completedWorkers: this.results.length,\r\n      totalErrors: this.errors.length,\r\n      errors: this.errors,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Função de conveniência para usar o pool de workers\r\n */\r\nexport async function processarComWorkers(\r\n  files: FileEntryWithAst[],\r\n  techniques: Tecnica[],\r\n  context: ContextoExecucao,\r\n  options?: WorkerPoolOptions,\r\n): Promise<{\r\n  occurrences: Ocorrencia[];\r\n  metrics: MetricaAnalista[];\r\n  totalProcessed: number;\r\n  duration: number;\r\n}> {\r\n  const pool = new WorkerPool(options);\r\n  return await pool.processFiles(files, techniques, context);\r\n}\r\n"]}