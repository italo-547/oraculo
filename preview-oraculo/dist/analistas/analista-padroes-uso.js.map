{"version":3,"file":"analista-padroes-uso.js","sourceRoot":"","sources":["../../src/analistas/analista-padroes-uso.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\r\n// src/analistas/analista-padroes-uso.ts\r\nimport * as t from '@babel/types';\r\nimport type { NodePath } from '@babel/traverse';\r\nimport { traverse } from '../nucleo/constelacao/traverse.js';\r\nimport { incrementar, garantirArray } from '../zeladores/util/helpers-analistas.js';\r\nimport type {\r\n  Estatisticas,\r\n  Ocorrencia,\r\n  ContextoExecucao,\r\n  TecnicaAplicarResultado,\r\n} from '../tipos/tipos.js';\r\n\r\n// Estatísticas globais (mantidas)\r\nexport const estatisticasUsoGlobal: Estatisticas = {\r\n  requires: {},\r\n  consts: {},\r\n  exports: {},\r\n  vars: {},\r\n  lets: {},\r\n  evals: {},\r\n  withs: {},\r\n};\r\n\r\nexport const analistaPadroesUso = {\r\n  nome: 'analista-padroes-uso',\r\n  global: true,\r\n  test: (relPath: string): boolean => relPath.endsWith('.js') || relPath.endsWith('.ts'),\r\n  aplicar: (\r\n    _src: string,\r\n    _relPath: string,\r\n    _ast: unknown,\r\n    _fullPath?: string,\r\n    contexto?: ContextoExecucao,\r\n  ): TecnicaAplicarResultado => {\r\n    const ocorrencias: Ocorrencia[] = [];\r\n\r\n    const statsFlag = estatisticasUsoGlobal as Estatisticas & { ___RESET_DONE___?: boolean };\r\n    if (!statsFlag.___RESET_DONE___) {\r\n      estatisticasUsoGlobal.requires = {};\r\n      estatisticasUsoGlobal.consts = {};\r\n      estatisticasUsoGlobal.exports = {};\r\n      estatisticasUsoGlobal.vars = {};\r\n      estatisticasUsoGlobal.lets = {};\r\n      estatisticasUsoGlobal.evals = {};\r\n      estatisticasUsoGlobal.withs = {};\r\n      statsFlag.___RESET_DONE___ = true;\r\n    }\r\n\r\n    if (!contexto) return null;\r\n\r\n    for (const file of contexto.arquivos) {\r\n      const astWrap = file.ast as unknown as { node?: unknown; type?: string } | undefined;\r\n      const ast = (astWrap && (astWrap as { node?: unknown }).node) || astWrap;\r\n      if (!ast || typeof ast !== 'object') continue;\r\n      const tipo = (ast as { type?: string }).type;\r\n      if (tipo !== 'File' && tipo !== 'Program') continue; // evita traverse inválido\r\n      const relPath = file.relPath || '';\r\n\r\n      try {\r\n        traverse(ast as unknown as t.Node, {\r\n          enter(path: NodePath<t.Node>) {\r\n            const node = path.node;\r\n\r\n            if (t.isVariableDeclaration(node) && node.kind === 'var') {\r\n              incrementar(estatisticasUsoGlobal.vars, relPath);\r\n              ocorrencias.push({\r\n                tipo: 'alerta',\r\n                mensagem: `Uso de 'var' detectado. Prefira 'let' ou 'const'.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n            if (t.isVariableDeclaration(node) && node.kind === 'let') {\r\n              incrementar(estatisticasUsoGlobal.lets, relPath);\r\n              ocorrencias.push({\r\n                tipo: 'info',\r\n                mensagem: `Uso de 'let'. Considere 'const' se não houver reatribuição.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n            if (t.isVariableDeclaration(node) && node.kind === 'const') {\r\n              incrementar(estatisticasUsoGlobal.consts, relPath);\r\n            }\r\n            if (t.isCallExpression(node) && t.isIdentifier(node.callee)) {\r\n              const nome = node.callee.name;\r\n              if (nome === 'require') {\r\n                incrementar(estatisticasUsoGlobal.requires, relPath);\r\n                if (relPath.endsWith('.ts')) {\r\n                  ocorrencias.push({\r\n                    tipo: 'alerta',\r\n                    mensagem: `Uso de 'require' em arquivo TypeScript. Prefira 'import'.`,\r\n                    arquivo: relPath,\r\n                    linha: node.loc?.start.line,\r\n                    coluna: node.loc?.start.column,\r\n                  });\r\n                }\r\n              }\r\n              if (nome === 'eval') {\r\n                incrementar(estatisticasUsoGlobal.evals, relPath);\r\n                ocorrencias.push({\r\n                  tipo: 'critico',\r\n                  mensagem: `Uso de 'eval' detectado. Evite por questões de segurança e performance.`,\r\n                  arquivo: relPath,\r\n                  linha: node.loc?.start.line,\r\n                  coluna: node.loc?.start.column,\r\n                });\r\n              }\r\n            }\r\n            if (t.isExportNamedDeclaration(node) || t.isExportDefaultDeclaration(node)) {\r\n              incrementar(estatisticasUsoGlobal.exports, relPath);\r\n            }\r\n            if (\r\n              t.isAssignmentExpression(node) &&\r\n              t.isMemberExpression(node.left) &&\r\n              ((t.isIdentifier(node.left.object) &&\r\n                node.left.object.name === 'module' &&\r\n                t.isIdentifier(node.left.property) &&\r\n                node.left.property.name === 'exports') ||\r\n                (t.isIdentifier(node.left.object) && node.left.object.name === 'exports')) &&\r\n              relPath.endsWith('.ts')\r\n            ) {\r\n              ocorrencias.push({\r\n                tipo: 'alerta',\r\n                mensagem: `Uso de 'module.exports' ou 'exports' em arquivo TypeScript. Prefira 'export'.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n            if (t.isWithStatement(node)) {\r\n              incrementar(estatisticasUsoGlobal.withs, relPath);\r\n              ocorrencias.push({\r\n                tipo: 'critico',\r\n                mensagem: `Uso de 'with' detectado. Evite por questões de legibilidade e escopo.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n            if (\r\n              (t.isFunctionExpression(node) || t.isFunctionDeclaration(node)) &&\r\n              !node.id &&\r\n              !t.isArrowFunctionExpression(node)\r\n            ) {\r\n              ocorrencias.push({\r\n                tipo: 'info',\r\n                mensagem: `Função anônima detectada. Considere nomear funções para melhor rastreabilidade.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n            // Arrow function em propriedade de classe (Babel 7+: ClassProperty/PropertyDefinition)\r\n            if (\r\n              (node.type === 'ClassProperty' ||\r\n                (node as { type?: string }).type === 'PropertyDefinition') &&\r\n              'value' in (node as unknown as Record<string, unknown>) &&\r\n              t.isArrowFunctionExpression(\r\n                (node as unknown as Record<string, unknown>).value as t.Node,\r\n              )\r\n            ) {\r\n              ocorrencias.push({\r\n                tipo: 'info',\r\n                mensagem: `Arrow function usada como método de classe. Prefira método tradicional para melhor herança.`,\r\n                arquivo: relPath,\r\n                linha: node.loc?.start.line,\r\n                coluna: node.loc?.start.column,\r\n              });\r\n            }\r\n          },\r\n        });\r\n      } catch (e) {\r\n        ocorrencias.push({\r\n          tipo: 'ERRO_ANALISTA',\r\n          mensagem: `Falha ao analisar padrões de uso em ${relPath}: ${(e as Error).message}`,\r\n          arquivo: relPath,\r\n          origem: 'analista-padroes-uso',\r\n        } as Ocorrencia);\r\n      }\r\n    }\r\n\r\n    return garantirArray(ocorrencias);\r\n  },\r\n};\r\n"]}