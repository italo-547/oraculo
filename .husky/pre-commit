#!/usr/bin/env sh
# Husky v9 pre-commit: executa lint-staged
echo "üîç pre-commit: executando lint-staged"
# Usa o arquivo de configura√ß√£o correto (.lintstageddrc.mjs) ‚Äî nome hist√≥rico do projeto
NODE_OPTIONS= npx lint-staged --config ./.lintstageddrc.mjs --cwd . --quiet || { echo "lint-staged falhou; executando verifica√ß√£o completa (npm run check)"; npm run check || exit 1; }

# Varredura r√°pida de poss√≠veis segredos nos arquivos staged
echo "üõ°Ô∏è  pre-commit: scan r√°pido por segredos em arquivos staged"
if command -v git >/dev/null 2>&1; then
	# Lista nomes dos arquivos staged de texto
	files=$(git diff --cached --name-only --diff-filter=ACMRT | tr -d '\r')
	if [ -n "$files" ]; then
		hit=0
		for f in $files; do
			# s√≥ examina arquivos plausivelmente de texto
			if [ -f "$f" ]; then
				if grep -E -i 'ghp_[A-Za-z0-9]{36}|github_pat_[A-Za-z0-9_]{80,}|AIza[0-9A-Za-z-_]{35}|SECRET_KEY|API_KEY|ACCESS_TOKEN' "$f" >/dev/null 2>&1; then
					echo "‚ùå pre-commit: poss√≠vel segredo encontrado em $f"
					hit=1
				fi
			fi
		done
		if [ $hit -eq 1 ]; then
			echo "Interrompendo commit. Remova/mascare segredos e tente novamente."
			exit 1
		fi
	fi
fi
