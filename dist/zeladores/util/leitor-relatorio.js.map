{"version":3,"file":"leitor-relatorio.js","sourceRoot":"","sources":["../../../src/zeladores/util/leitor-relatorio.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\r\n/**\r\n * Utilitários para trabalhar com relatórios JSON versionados\r\n */\r\n\r\nimport { lerEstado } from './persistencia.js';\r\nimport { validarSchema, migrarParaVersaoAtual } from '@nucleo/schema-versao.js';\r\n\r\nexport interface LeitorRelatorioOptions {\r\n  /** Caminho do arquivo do relatório */\r\n  caminho: string;\r\n  /** Se deve validar o schema (padrão: true) */\r\n  validar?: boolean;\r\n  /** Se deve migrar para versão atual se necessário (padrão: true) */\r\n  migrar?: boolean;\r\n}\r\n\r\n/**\r\n * Lê um relatório JSON versionado do disco\r\n */\r\nexport async function lerRelatorioVersionado<T = unknown>(\r\n  options: LeitorRelatorioOptions,\r\n): Promise<{\r\n  sucesso: boolean;\r\n  dados?: T;\r\n  schema?: Record<string, unknown>;\r\n  erro?: string;\r\n  migrado?: boolean;\r\n}> {\r\n  const { caminho, validar = true, migrar = true } = options;\r\n\r\n  try {\r\n    // Ler arquivo\r\n    const conteudo = await lerEstado<Record<string, unknown>>(caminho);\r\n\r\n    if (!conteudo) {\r\n      return {\r\n        sucesso: false,\r\n        erro: 'Arquivo não encontrado ou vazio',\r\n      };\r\n    }\r\n\r\n    let relatorioFinal = conteudo;\r\n    let migrado = false;\r\n\r\n    // Validar schema se solicitado\r\n    if (validar) {\r\n      const validacao = validarSchema(conteudo);\r\n      if (!validacao.valido) {\r\n        return {\r\n          sucesso: false,\r\n          erro: `Schema inválido: ${validacao.erros.join(', ')}`,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Migrar se necessário e solicitado\r\n    if (migrar && (!conteudo._schema || !conteudo.dados)) {\r\n      relatorioFinal = migrarParaVersaoAtual<unknown>(conteudo) as unknown as Record<\r\n        string,\r\n        unknown\r\n      >;\r\n      migrado = true;\r\n    }\r\n\r\n    // Extrair dados\r\n    const dados = (relatorioFinal.dados || relatorioFinal) as T;\r\n\r\n    return {\r\n      sucesso: true,\r\n      dados,\r\n      schema: relatorioFinal._schema as Record<string, unknown> | undefined,\r\n      migrado,\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      sucesso: false,\r\n      erro: `Erro ao ler relatório: ${error instanceof Error ? error.message : String(error)}`,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Lê apenas os dados de um relatório, ignorando metadados de versão\r\n */\r\nexport async function lerDadosRelatorio<T = unknown>(\r\n  caminho: string,\r\n): Promise<{\r\n  sucesso: boolean;\r\n  dados?: T;\r\n  erro?: string;\r\n}> {\r\n  const resultado = await lerRelatorioVersionado<T>({\r\n    caminho,\r\n    validar: false,\r\n    migrar: true,\r\n  });\r\n\r\n  return {\r\n    sucesso: resultado.sucesso,\r\n    dados: resultado.dados,\r\n    erro: resultado.erro,\r\n  };\r\n}\r\n\r\n/**\r\n * Verifica se um relatório tem schema válido\r\n */\r\nexport async function verificarSchemaRelatorio(caminho: string): Promise<{\r\n  valido: boolean;\r\n  versao?: string;\r\n  erros?: string[];\r\n  erro?: string;\r\n}> {\r\n  try {\r\n    const conteudo = await lerEstado<Record<string, unknown>>(caminho);\r\n\r\n    if (!conteudo) {\r\n      return {\r\n        valido: false,\r\n        erros: ['Arquivo não encontrado ou vazio'],\r\n      };\r\n    }\r\n\r\n    const validacao = validarSchema(conteudo);\r\n\r\n    return {\r\n      valido: validacao.valido,\r\n      versao: (conteudo._schema as Record<string, unknown>)?.versao as string | undefined,\r\n      erros: validacao.erros,\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      valido: false,\r\n      erro: `Erro ao verificar schema: ${error instanceof Error ? error.message : String(error)}`,\r\n    };\r\n  }\r\n}\r\n"]}