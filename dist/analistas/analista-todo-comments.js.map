{"version":3,"file":"analista-todo-comments.js","sourceRoot":"","sources":["../../src/analistas/analista-todo-comments.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\r\nimport type { Analista, TecnicaAplicarResultado } from '@tipos/tipos.js';\r\nimport { criarOcorrencia } from '@tipos/tipos.js';\r\nimport type { NodePath } from '@babel/traverse';\r\nimport type { Comment } from '@babel/types';\r\n\r\n// Analista simples para detectar TODO em comentários (//, /* */), ignorando testes/specs\r\nexport const analistaTodoComments: Analista = {\r\n  nome: 'todo-comments',\r\n  categoria: 'qualidade',\r\n  descricao: 'Detecta comentários TODO deixados no código (apenas em comentários).',\r\n  // Per-file (não global): executa por arquivo\r\n  global: false,\r\n  test(relPath) {\r\n    // Ignora arquivos de teste/spec e pastas comuns de teste\r\n    if (\r\n      /(^|\\\\|\\/)tests?(\\\\|\\/)/i.test(relPath) ||\r\n      /\\.(test|spec)\\.(ts|js|tsx|jsx)$/i.test(relPath)\r\n    ) {\r\n      return false;\r\n    }\r\n    // Delega escopo ao scanner/CLI: não restringe por caminho aqui\r\n    // normalização não é necessária aqui; scanner controla escopo\r\n    // Evita auto-detecção neste próprio arquivo\r\n    if (/analistas[\\\\\\/]analista-todo-comments\\.(ts|js)$/i.test(relPath)) return false;\r\n    return /\\.(ts|js|tsx|jsx)$/i.test(relPath);\r\n  },\r\n  aplicar(src, relPath, ast?: NodePath | null): TecnicaAplicarResultado {\r\n    const RE_TODO_START = /^TODO\\b/i;\r\n    const RE_TODO_ANY = /\\bTODO\\b\\s*[:\\-(\\[]/i;\r\n    const isTodoComment = (texto: string): boolean => {\r\n      const t = String(texto ?? '').trim();\r\n      return RE_TODO_START.test(t) || RE_TODO_ANY.test(t);\r\n    };\r\n\r\n    // Localiza marcadores de comentário ignorando ocorrências dentro de strings (', \", `)\r\n    const localizarMarcadores = (linha: string): { lineIdx: number; blockIdx: number } => {\r\n      let inS = false;\r\n      let inD = false;\r\n      let inB = false;\r\n      let prev = '';\r\n      for (let i = 0; i < linha.length; i++) {\r\n        const ch = linha[i];\r\n        const pair = prev + ch;\r\n        // alterna estados de string considerando escapes simples\r\n        if (!inD && !inB && ch === \"'\" && prev !== '\\\\') inS = !inS;\r\n        else if (!inS && !inB && ch === '\"' && prev !== '\\\\') inD = !inD;\r\n        else if (!inS && !inD && ch === '`' && prev !== '\\\\') inB = !inB;\r\n\r\n        // apenas quando não dentro de strings detectar comentários\r\n        if (!inS && !inD && !inB) {\r\n          if (pair === '//') {\r\n            return { lineIdx: i - 1, blockIdx: -1 };\r\n          }\r\n          if (pair === '/*') {\r\n            return { lineIdx: -1, blockIdx: i - 1 };\r\n          }\r\n        }\r\n        prev = ch;\r\n      }\r\n      return { lineIdx: -1, blockIdx: -1 };\r\n    };\r\n    if (!src || typeof src !== 'string') return null;\r\n    // Evita auto-detecção neste próprio arquivo (defesa dupla)\r\n    if (/analistas[\\\\\\/]analista-todo-comments\\.(ts|js)$/i.test(relPath)) return null;\r\n\r\n    // Caminho preferencial: usar comentários da AST quando disponível\r\n  if (ast && ast.node) {\r\n      const maybeWithComments = ast.node as unknown as { comments?: Comment[] };\r\n      if (Array.isArray(maybeWithComments.comments)) {\r\n        const comments = maybeWithComments.comments;\r\n        const ocorrencias = comments\r\n          .filter((c) => {\r\n      const texto = String(c.value ?? '').trim();\r\n      return isTodoComment(texto);\r\n          })\r\n          .map((c) =>\r\n            criarOcorrencia({\r\n              tipo: 'TODO_PENDENTE',\r\n              mensagem: 'Comentário TODO encontrado',\r\n              nivel: 'aviso',\r\n              relPath,\r\n              linha: c.loc?.start.line,\r\n              origem: 'todo-comments',\r\n            }),\r\n          );\r\n        return ocorrencias.length ? ocorrencias : null;\r\n      }\r\n    }\r\n\r\n    // Heurística: considera TODO apenas quando presente em comentários\r\n  const linhas = src.split(/\\r?\\n/);\r\n    const ocorrenciasLinhas: number[] = [];\r\n    let emBloco = false;\r\n    for (let i = 0; i < linhas.length; i++) {\r\n      const linha = linhas[i];\r\n      let analisada = false;\r\n\r\n      // Verifica comentários de bloco (/* ... */)\r\n      if (emBloco) {\r\n        analisada = true;\r\n    if (isTodoComment(linha)) {\r\n          ocorrenciasLinhas.push(i + 1);\r\n        }\r\n        if (linha.includes('*/')) {\r\n          emBloco = false;\r\n        }\r\n      }\r\n\r\n      if (!analisada) {\r\n    // Procura início de bloco e comentário de linha ignorando strings\r\n    const { blockIdx: idxBlockStart, lineIdx: idxLine } = localizarMarcadores(linha);\r\n\r\n        // Caso comentário de linha\r\n        if (idxLine >= 0 && (idxBlockStart === -1 || idxLine < idxBlockStart)) {\r\n          const trechoComentario = linha.slice(idxLine + 2);\r\n          if (isTodoComment(trechoComentario)) {\r\n            ocorrenciasLinhas.push(i + 1);\r\n          }\r\n          continue;\r\n        }\r\n\r\n        // Caso bloco começando nesta linha\r\n        if (idxBlockStart >= 0) {\r\n          const trechoAposInicio = linha.slice(idxBlockStart + 2);\r\n          if (isTodoComment(trechoAposInicio)) {\r\n            ocorrenciasLinhas.push(i + 1);\r\n          }\r\n          if (!linha.includes('*/')) {\r\n            emBloco = true;\r\n          }\r\n          continue;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (ocorrenciasLinhas.length === 0) return null;\r\n\r\n    return ocorrenciasLinhas.map((linha) =>\r\n      criarOcorrencia({\r\n        tipo: 'TODO_PENDENTE',\r\n        mensagem: 'Comentário TODO encontrado',\r\n        nivel: 'aviso',\r\n        relPath,\r\n        linha,\r\n        origem: 'todo-comments',\r\n      }),\r\n    );\r\n  },\r\n};\r\n\r\nexport default analistaTodoComments;\r\n"]}